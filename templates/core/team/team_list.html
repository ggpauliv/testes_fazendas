{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Equipe - {{ empresa.nome }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        {% if can_invite %}
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#inviteModal">
            <i class="bi bi-envelope-plus"></i> Convidar Novo Usuário
        </button>
        {% endif %}
    </div>
</div>

<div class="row">
    <!-- Lista de Usuários Ativos -->
    <div class="col-md-12 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-people"></i> Membros da Equipe</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Função</th>
                                <th>Status</th>
                                <th class="text-end">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for profile in users %}
                            <tr>
                                <td>{{ profile.user.get_full_name|default:profile.user.username }}</td>
                                <td>{{ profile.user.email }}</td>
                                <td>
                                    <span class="badge {% if profile.role == 'OWNER' %}bg-warning text-dark{% elif profile.role == 'MANAGER' %}bg-primary{% else %}bg-secondary{% endif %}">
                                        {{ profile.get_role_display }}
                                    </span>
                                </td>
                                <td><span class="badge bg-success">Ativo</span></td>
                                <td class="text-end">
                                    {% if request.user.userprofile.role == 'OWNER' and profile.user != request.user %}
                                    <button class="btn btn-sm btn-outline-danger" title="Remover"><i class="bi bi-trash"></i></button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-3">Nenhum usuário encontrado.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Convites Pendentes -->
    <div class="col-md-12">
        <div class="card shadow-sm border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-hourglass-split"></i> Convites Pendentes</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Email Convidado</th>
                                <th>Função</th>
                                <th>Data Convite</th>
                                <th>Link (Cópia Rápida)</th>
                                <th class="text-end">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for invite in invitations %}
                            <tr>
                                <td>{{ invite.email }}</td>
                                <td>{{ invite.get_role_display }}</td>
                                <td>{{ invite.created_at|date:"d/m/Y H:i" }}</td>
                                <td>
                                    <div class="input-group input-group-sm" style="max-width: 300px;">
                                        <input type="text" class="form-control" value="{% url 'accept_invite' invite.token %}" id="invite-link-{{ invite.id }}" readonly>
                                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('invite-link-{{ invite.id }}')">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                    </div>
                                </td>
                                <td class="text-end">
                                    <form method="post" action="{% url 'cancel_invite' invite.id %}" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja cancelar o convite para {{ invite.email }}?');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i class="bi bi-x-circle"></i> Cancelar
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-3 text-muted">Nenhum convite pendente.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Convite -->
<div class="modal fade" id="inviteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Convidar Novo Usuário</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'invite_user' %}">
                    {% csrf_token %}
                    <input type="hidden" name="empresa_id" value="{{ empresa.id }}">
                    {{ invite_form|crispy }}
                    <div class="d-grid mt-3">
                        <button type="submit" class="btn btn-success">Enviar Convite</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function copyToClipboard(elementId) {
    var copyText = document.getElementById(elementId);
    
    // Concatena o domínio atual se o link for relativo
    var fullLink = window.location.origin + copyText.value;
    
    navigator.clipboard.writeText(fullLink).then(function() {
        alert('Link copiado!');
    }, function(err) {
        console.error('Erro ao copiar: ', err);
    });
}
</script>
{% endblock %}
