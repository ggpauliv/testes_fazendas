{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>{% block title %}Gestor Talhão{% endblock %} | HK Consultoria</title>
    <link rel="icon" href="{% static 'img/logo_rosto.png' %}" type="image/png">

    <!-- Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap 5 & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Custom CSS -->
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    <style>
         /* Market Ticker Styles */
        .market-ticker {
            background-color: #1a202c; /* Darker background */
            color: #e2e8f0;
            font-size: 0.85rem;
            border-bottom: 1px solid #2d3748;
            overflow-x: auto; /* Allow scrolling on mobile */
            white-space: nowrap; /* Prevent wrapping */
        }
    
        .ticker-item {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-right: 1px solid #2d3748;
        }
    
        .ticker-label {
            font-weight: 600;
            margin-right: 0.5rem;
            color: #cbd5e0;
        }
    
        .ticker-value {
            font-family: 'Roboto Mono', monospace;
            font-weight: 500;
        }
    
        .ticker-trend-up { color: #48bb78; }
        .ticker-trend-down { color: #f56565; }
        .ticker-neutral { color: #a0aec0; }
    </style>
    {% block extra_css %}{% endblock %}
</head>

<body>
    <div class="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar" class="sidebar js-sidebar">
            <div class="sidebar-content js-simplebar">
                <a class="sidebar-brand" href="{% url 'dashboard' %}">
                    <span class="align-middle">Gestor Talhão</span>
                </a>

                <ul class="sidebar-nav">
                    <li class="sidebar-header">
                        Principal
                    </li>

                    <li class="sidebar-item {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
                        <a class="sidebar-link" href="{% url 'dashboard' %}">
                            <i class="bi bi-speedometer2 align-middle"></i> <span class="align-middle">Dashboard</span>
                        </a>
                    </li>

                    <li class="sidebar-item {% if 'fazenda' in request.path %}active{% endif %}">
                        <a class="sidebar-link" href="{% url 'fazenda_list' %}">
                            <i class="bi bi-geo-alt align-middle"></i> <span class="align-middle">Fazendas</span>
                        </a>
                    </li>



                    <li class="sidebar-header" data-bs-toggle="collapse" data-bs-target="#estoqueMenu" aria-expanded="{% if 'produtos' in request.path or 'movimentacoes' in request.path %}true{% else %}false{% endif %}">
                        Estoque
                    </li>
                    <div id="estoqueMenu" class="collapse {% if 'produtos' in request.path or 'movimentacoes' in request.path %}show{% endif %}">
                        <li class="sidebar-item {% if 'produtos' in request.path %}active{% endif %}">
                            <a class="sidebar-link" href="{% url 'produto_list' %}">
                                <i class="bi bi-box me-2 align-middle"></i> <span class="align-middle">Produtos</span>
                            </a>
                        </li>
                        <li class="sidebar-item {% if 'movimentacoes' in request.path %}active{% endif %}">
                            <a class="sidebar-link" href="{% url 'movimentacao_list' %}">
                                <i class="bi bi-arrow-left-right me-2 align-middle"></i> <span class="align-middle">Movimentações</span>
                            </a>
                        </li>
                    </div>

                    <li class="sidebar-header" data-bs-toggle="collapse" data-bs-target="#cadastrosMenu" aria-expanded="{% if 'clientes' in request.path or 'fornecedores' in request.path or 'armazens' in request.path or 'safras' in request.path %}true{% else %}false{% endif %}">
                        Cadastros
                    </li>
                    <div id="cadastrosMenu" class="collapse {% if 'clientes' in request.path or 'fornecedores' in request.path or 'armazens' in request.path or 'safras' in request.path %}show{% endif %}">
                        <li class="sidebar-item {% if 'clientes' in request.path %}active{% endif %}">
                            <a class="sidebar-link" href="{% url 'cliente_list' %}">
                                <i class="bi bi-person-check me-2 align-middle"></i> <span class="align-middle">Clientes</span>
                            </a>
                        </li>
                        <li class="sidebar-item {% if 'fornecedores' in request.path %}active{% endif %}">
                            <a class="sidebar-link" href="{% url 'fornecedor_list' %}">
                                <i class="bi bi-person-gear me-2 align-middle"></i> <span class="align-middle">Fornecedores</span>
                            </a>
                        </li>
                         <li class="sidebar-item {% if 'armazens' in request.path %}active{% endif %}">
                            <a class="sidebar-link" href="{% url 'armazem_list' %}">
                                <i class="bi bi-building me-2 align-middle"></i> <span class="align-middle">Taxas Armazém</span>
                            </a>
                        </li>
                        <li class="sidebar-item {% if 'safras' in request.path %}active{% endif %}">
                            <a class="sidebar-link" href="{% url 'safra_list' %}">
                                <i class="bi bi-calendar-event me-2 align-middle"></i> <span class="align-middle">Safras</span>
                            </a>
                        </li>
                    </div>

                    <li class="sidebar-header" data-bs-toggle="collapse" data-bs-target="#producaoMenu" aria-expanded="{% if 'ciclos' in request.path or 'operacoes' in request.path or 'requisicoes' in request.path or 'romaneios' in request.path and 'relatorio' not in request.path %}true{% else %}false{% endif %}">
                        Produção
                    </li>
                     <div id="producaoMenu" class="collapse {% if 'ciclos' in request.path or 'operacoes' in request.path or 'requisicoes' in request.path or 'romaneios' in request.path and 'relatorio' not in request.path %}show{% endif %}">
                        <li class="sidebar-item {% if 'ciclos' in request.path %}active{% endif %}">
                            <a class="sidebar-link" href="{% url 'ciclo_list' %}">
                                <i class="bi bi-calendar3 me-2 align-middle"></i> <span class="align-middle">Ciclos de Produção</span>
                            </a>
                        </li>
                        <li class="sidebar-item {% if 'romaneios' in request.path and 'relatorio' not in request.path %}active{% endif %}">
                            <a class="sidebar-link" href="{% url 'romaneio_list' %}">
                                <i class="bi bi-receipt me-2 align-middle"></i> <span class="align-middle">Romaneios</span>
                            </a>
                        </li>
                        <li class="sidebar-item {% if 'operacoes' in request.path %}active{% endif %}">
                            <a class="sidebar-link" href="{% url 'operacao_list' %}">
                                <i class="bi bi-gear me-2 align-middle"></i> <span class="align-middle">Operações</span>
                            </a>
                        </li>
                        <li class="sidebar-item {% if 'requisicoes' in request.path %}active{% endif %}">
                            <a class="sidebar-link" href="{% url 'requisicao_list' %}">
                                <i class="bi bi-cart-check me-2 align-middle"></i> <span class="align-middle">Requisições</span>
                            </a>
                        </li>
                    </div>

                    <li class="sidebar-header" data-bs-toggle="collapse" data-bs-target="#monitoramentoMenu" aria-expanded="{% if 'monitoramento' in request.path %}true{% else %}false{% endif %}">
                        Monitoramento
                    </li>
                    <div id="monitoramentoMenu" class="collapse {% if 'monitoramento' in request.path %}show{% endif %}">
                        <li class="sidebar-item {% if 'monitoramento/alvos' in request.path %}active{% endif %}">
                            <a class="sidebar-link" href="{% url 'alvo_list' %}">
                                <i class="bi bi-bug me-2 align-middle"></i> <span class="align-middle">Catálogo de Alvos</span>
                            </a>
                        </li>
                        <li class="sidebar-item {% if 'monitoramento' in request.path and 'alvos' not in request.path %}active{% endif %}">
                            <a class="sidebar-link" href="{% url 'monitoramento_list' %}">
                                <i class="bi bi-clipboard-check me-2 align-middle"></i> <span class="align-middle">Inspeções (Scouting)</span>
                            </a>
                        </li>
                    </div>

                    <li class="sidebar-header" data-bs-toggle="collapse" data-bs-target="#financeiroMenu" aria-expanded="{% if 'financeiro' in request.path and 'relatorio' not in request.path %}true{% else %}false{% endif %}">
                        Financeiro
                    </li>
                    <div id="financeiroMenu" class="collapse {% if 'financeiro' in request.path and 'relatorio' not in request.path %}show{% endif %}">
                        <li class="sidebar-item {% if request.resolver_match.url_name == 'financeiro_dashboard' %}active{% endif %}">
                            <a class="sidebar-link" href="{% url 'financeiro_dashboard' %}">
                                <i class="bi bi-wallet2 me-2 align-middle"></i> <span class="align-middle">Dashboard Fin.</span>
                            </a>
                        </li>
                        <li class="sidebar-item {% if 'financeiro/pagar' in request.path %}active{% endif %}">
                            <a class="sidebar-link" href="{% url 'conta_pagar_list' %}">
                                <i class="bi bi-cash-stack me-2 align-middle"></i> <span class="align-middle">Contas a Pagar</span>
                            </a>
                        </li>
                        <li class="sidebar-item {% if 'financeiro/receber' in request.path %}active{% endif %}">
                            <a class="sidebar-link" href="{% url 'conta_receber_list' %}">
                                <i class="bi bi-cash-coin me-2 align-middle"></i> <span class="align-middle">Contas a Receber</span>
                            </a>
                        </li>
                        <li class="sidebar-item {% if 'financeiro/config' in request.path %}active{% endif %}">
                            <a class="sidebar-link" href="{% url 'financeiro_config' %}">
                                <i class="bi bi-gear-fill me-2 align-middle"></i> <span class="align-middle">Configurações</span>
                            </a>
                        </li>
                    </div>

                    <li class="sidebar-header" data-bs-toggle="collapse" data-bs-target="#comercialMenu" aria-expanded="{% if 'pedidos' in request.path or 'contratos' in request.path or 'fixacoes' in request.path or 'rateios' in request.path %}true{% else %}false{% endif %}">
                        Comercial
                    </li>
                    <div id="comercialMenu" class="collapse {% if 'pedidos' in request.path or 'contratos' in request.path or 'fixacoes' in request.path or 'rateios' in request.path %}show{% endif %}">
                        <li class="sidebar-item {% if 'pedidos' in request.path %}active{% endif %}">
                            <a class="sidebar-link" href="{% url 'pedido_list' %}">
                                <i class="bi bi-basket me-2 align-middle"></i> <span class="align-middle">Pedidos Compra</span>
                            </a>
                        </li>
                         <li class="sidebar-item {% if 'contratos' in request.path %}active{% endif %}">
                            <a class="sidebar-link" href="{% url 'contrato_list' %}">
                                <i class="bi bi-file-text me-2 align-middle"></i> <span class="align-middle">Contratos Venda</span>
                            </a>
                        </li>
                        <li class="sidebar-item {% if 'fixacoes' in request.path %}active{% endif %}">
                            <a class="sidebar-link" href="{% url 'fixacao_list' %}">
                                <i class="bi bi-tag me-2 align-middle"></i> <span class="align-middle">Fixações Preço</span>
                            </a>
                        </li>
                        <li class="sidebar-item {% if 'rateios' in request.path %}active{% endif %}">
                            <a class="sidebar-link" href="{% url 'rateio_list' %}">
                                <i class="bi bi-pie-chart me-2 align-middle"></i> <span class="align-middle">Rateio Custos</span>
                            </a>
                        </li>
                    </div>

                    <li class="sidebar-header" data-bs-toggle="collapse" data-bs-target="#relatoriosMenu" aria-expanded="{% if 'relatorio' in request.path %}true{% else %}false{% endif %}">
                        Relatórios
                    </li>
                     <div id="relatoriosMenu" class="collapse {% if 'relatorio' in request.path %}show{% endif %}">
                        <li class="sidebar-item {% if 'producao' in request.path %}active{% endif %}">
                             <a class="sidebar-link" href="{% url 'relatorio_producao' %}">
                                <i class="bi bi-speedometer2 me-2 align-middle"></i> <span class="align-middle">Produtividade</span>
                            </a>
                        </li>
                         <li class="sidebar-item {% if 'relatorio_romaneios' in request.path %}active{% endif %}">
                             <a class="sidebar-link" href="{% url 'relatorio_romaneios' %}">
                                <i class="bi bi-truck me-2 align-middle"></i> <span class="align-middle">Colheita</span>
                            </a>
                        </li>
                        <li class="sidebar-item {% if 'financeiro' in request.path %}active{% endif %}">
                             <a class="sidebar-link" href="{% url 'relatorio_financeiro' %}">
                                <i class="bi bi-cash-coin me-2 align-middle"></i> <span class="align-middle">Financeiro</span>
                            </a>
                        </li>
                        <li class="sidebar-item {% if 'estoque' in request.path %}active{% endif %}">
                             <a class="sidebar-link" href="{% url 'relatorio_estoque' %}">
                                <i class="bi bi-box-seam me-2 align-middle"></i> <span class="align-middle">Estoque Atual</span>
                            </a>
                        </li>
                        <li class="sidebar-item {% if 'custos' in request.path %}active{% endif %}">
                             <a class="sidebar-link" href="{% url 'relatorio_custos' %}">
                                <i class="bi bi-pie-chart-fill me-2 align-middle"></i> <span class="align-middle">Custos Oper.</span>
                            </a>
                        </li>
                    </div>

                    {% if user.is_superuser %}
                    <li class="sidebar-header" data-bs-toggle="collapse" data-bs-target="#adminSaasMenu" aria-expanded="{% if 'saas' in request.path %}true{% else %}false{% endif %}">
                        Admin SaaS
                    </li>
                    <div id="adminSaasMenu" class="collapse {% if 'saas' in request.path %}show{% endif %}">
                        <li class="sidebar-item {% if 'saas' in request.path %}active{% endif %}">
                            <a class="sidebar-link" href="{% url 'saas_create_tenant' %}">
                                <i class="bi bi-building-add me-2 align-middle"></i> <span class="align-middle">Cadastrar Empresa</span>
                            </a>
                        </li>
                        <li class="sidebar-item">
                            <a class="sidebar-link" href="{% url 'saas_settings' %}">
                                <i class="bi bi-gear me-2 align-middle"></i> <span class="align-middle">Configurações</span>
                            </a>
                        </li>
                    </div>
                    {% endif %}
                </ul>
            </div>
        </nav>

        <div class="main">
            <!-- Navbar Mobile / Topbar -->
            <nav class="navbar navbar-expand navbar-light navbar-bg">
                <a class="sidebar-toggle js-sidebar-toggle">
                    <i class="bi bi-list fs-3"></i>
                </a>

                <!-- User Profile (Left Aligned) -->
                <ul class="navbar-nav ms-3">
                    <li class="nav-item dropdown">
                        <a class="nav-icon dropdown-toggle d-inline-block d-sm-none" href="#" data-bs-toggle="dropdown">
                            <i class="bi bi-gear align-middle"></i>
                        </a>

                        <a class="nav-link dropdown-toggle d-none d-sm-inline-block" href="#" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i> <span class="text-dark">{{ user.username|default:"Usuário" }}</span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-start">
                            <a class="dropdown-item" href="{% url 'profile_edit' %}"><i class="bi bi-person me-2"></i> Meu Perfil</a>
                            <a class="dropdown-item" href="{% url 'password_change' %}"><i class="bi bi-key me-2"></i> Alterar Senha</a>
                            {% if user.is_superuser or user.userprofile.role == 'OWNER' %}
                            <a class="dropdown-item" href="{% url 'team_list' %}"><i class="bi bi-people me-2"></i> Equipe</a>
                            {% endif %}
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item text-danger" href="{% url 'logout' %}"><i class="bi bi-box-arrow-right me-2"></i> Sair</a>
                        </div>
                    </li>
                </ul>

                <!-- Market Ticker (Right Aligned) -->
                <div class="d-none d-md-flex ms-auto align-items-center me-3">
                    <div id="market-ticker-content" class="d-flex align-items-center gap-4 small text-muted">
                        <!-- Content via JS -->
                         <div class="spinner-border spinner-border-sm text-secondary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </nav>

            <main class="content">
                <div class="container-fluid p-0">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    {% block content %}{% endblock %}
                </div>
            </main>

            <footer class="footer">
                <div class="container-fluid">
                    <div class="row text-muted">
                        <div class="col-6 text-start">
                            <p class="mb-0">
                                <strong>HK Consultoria</strong> &copy;
                            </p>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Simple Sidebar Toggler Script
        document.addEventListener("DOMContentLoaded", function() {
            const sidebarToggle = document.getElementsByClassName("js-sidebar-toggle")[0];
            const sidebar = document.getElementById("sidebar");
            
            if(sidebarToggle && sidebar){
                sidebarToggle.addEventListener("click", () => {
                   sidebar.classList.toggle("collapsed");
                });
            }
        });

        // System Config & Market Data Logic
        window.sistema_config = {
            nome_sistema: "{{ sistema_config.nome_sistema|default:'Agro Gestor' }}",
            logo_url: "{% if sistema_config.logo %}{{ sistema_config.logo.url }}{% endif %}",
            moeda_padrao: "{{ sistema_config.moeda_padrao|default:'BRL' }}"
        };

        // Market Data Fetcher
        async function fetchMarketData() {
            try {
                const response = await fetch('/api/market-data/');
                const data = await response.json();
                
                const tickerContainer = document.getElementById('market-ticker-content');
                if (!tickerContainer) return;

                if (!data.commodities || data.commodities.length === 0) {
                     tickerContainer.innerHTML = '<span class="text-muted"><i class="bi bi-exclamation-circle"></i> Sem cotações</span>';
                     return;
                }

                let html = '';
                
                data.commodities.forEach(item => {
                    let icon = 'bi-graph-up';
                    let colorClass = item.is_up ? 'text-success' : 'text-danger';
                    let arrow = item.is_up ? 'bi-arrow-up-short' : 'bi-arrow-down-short';
                    
                    if (item.symbol === 'USD') icon = 'bi-currency-dollar';
                    else if (item.name.includes('Soja')) icon = 'bi-flower1'; // Use flower1 for Soybean check
                    else if (item.name.includes('Milho')) icon = 'bi-flower3';
                    else if (item.name.includes('Boi')) icon = 'bi-piggy-bank'; // Or similar

                    html += `
                        <div class="d-flex align-items-center" title="${item.name}">
                            <i class="bi ${icon} me-1 text-secondary"></i> 
                            <span class="fw-bold me-1 text-dark">${item.name}:</span> 
                            <span class="me-1">${item.price}</span> 
                            <small class="${colorClass} d-flex align-items-center">
                                <i class="bi ${arrow}"></i>${item.change}%
                            </small>
                        </div>
                    `;
                });

                tickerContainer.innerHTML = html;

            } catch (error) {
                console.error("Erro ao carregar dados de mercado", error);
                const tickerContainer = document.getElementById('market-ticker-content');
                if (tickerContainer) tickerContainer.innerHTML = '<span class="text-muted small">Cotações indisponíveis</span>';
            }
        }
        
        // Init
        fetchMarketData();
        setInterval(fetchMarketData, 300000); // 5 min

    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>
